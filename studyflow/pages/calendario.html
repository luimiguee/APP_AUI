<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendário - StudyFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <div class="navbar-content">
        <a href="../index.html" class="navbar-brand">
          <div class="navbar-logo">S</div>
          <span>StudyFlow</span>
        </a>
        <nav>
          <ul class="navbar-nav" id="navbar-menu"></ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Page Content -->
  <div class="page-container">
    <div class="container">
      <div class="page-header flex-between">
        <div>
          <h1 class="page-title">Calendário</h1>
          <p class="page-subtitle">Visualizar tarefas por data</p>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-outline" onclick="changeMonth(-1)">← Anterior</button>
          <button class="btn btn-outline" onclick="goToToday()">Hoje</button>
          <button class="btn btn-outline" onclick="changeMonth(1)">Próximo →</button>
        </div>
      </div>

      <!-- Mês/Ano Atual -->
      <div class="card mb-4">
        <h2 id="current-month-year" style="text-align: center; margin: 0;"></h2>
      </div>

      <!-- Calendário -->
      <div class="card">
        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border);"></div>
      </div>

      <!-- Tarefas do Dia Selecionado -->
      <div class="card mt-4" id="selected-day-tasks" style="display: none;">
        <h3 id="selected-day-title"></h3>
        <div id="selected-day-tasks-list"></div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Verificar autenticação
    const user = JSON.parse(localStorage.getItem('studyflow-user') || 'null');
    if (!user) {
      window.location.href = '../login.html';
    }

    let currentDate = new Date();
    let tasks = [];
    let selectedDate = null;

    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

    // Carregar navbar
    function loadNavbar() {
      const menu = document.getElementById('navbar-menu');
      menu.innerHTML = `
        <li><a href="../dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="tarefas.html" class="navbar-link">Tarefas</a></li>
        <li><a href="calendario.html" class="navbar-link active">Calendário</a></li>
        <li><a href="perfil.html" class="navbar-link">Perfil</a></li>
        <li><a href="#" onclick="API.logout(); return false;" class="navbar-link">Sair</a></li>
      `;
    }

    // Carregar tarefas
    async function loadTasks() {
      try {
        tasks = await API.getTasks();
        renderCalendar();
      } catch (error) {
        console.error('Erro ao carregar tarefas:', error);
      }
    }

    // Mudar mês
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    // Ir para hoje
    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    // Renderizar calendário
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Atualizar título
      document.getElementById('current-month-year').textContent = 
        `${monthNames[month]} ${year}`;

      // Primeiro dia do mês
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      // Cabeçalho dos dias da semana
      let html = '<div style="background: var(--card-bg); padding: 1rem; text-align: center; font-weight: 600;">' +
                 dayNames.map(day => `<div>${day}</div>`).join('') + '</div>';

      // Dias vazios no início
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div style="background: var(--card-bg); min-height: 100px; padding: 0.5rem;"></div>';
      }

      // Dias do mês
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayTasks = tasks.filter(t => t.due_date === dateStr);
        const isToday = date.getTime() === today.getTime();
        const isSelected = selectedDate && dateStr === selectedDate;

        html += `
          <div style="background: var(--card-bg); min-height: 100px; padding: 0.5rem; border: ${isToday ? '2px solid var(--primary)' : '1px solid var(--border)'}; cursor: pointer; ${isSelected ? 'background: var(--hover-bg);' : ''}" 
               onclick="selectDate('${dateStr}')">
            <div style="font-weight: ${isToday ? 'bold' : 'normal'}; margin-bottom: 0.5rem;">${day}</div>
            ${dayTasks.slice(0, 3).map(task => {
              const statusColors = {
                'pendente': 'var(--warning)',
                'em_progresso': 'var(--primary)',
                'concluida': 'var(--secondary)'
              };
              return `<div style="background: ${statusColors[task.status]}; color: white; padding: 0.25rem; border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.title}</div>`;
            }).join('')}
            ${dayTasks.length > 3 ? `<div style="font-size: 0.75rem; color: var(--subtext);">+${dayTasks.length - 3} mais</div>` : ''}
          </div>
        `;
      }

      document.getElementById('calendar-grid').innerHTML = html;
    }

    // Selecionar data
    function selectDate(dateStr) {
      selectedDate = dateStr;
      const date = new Date(dateStr);
      const dayTasks = tasks.filter(t => t.due_date === dateStr);

      document.getElementById('selected-day-title').textContent = 
        `Tarefas de ${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

      if (dayTasks.length > 0) {
        document.getElementById('selected-day-tasks-list').innerHTML = dayTasks.map(task => {
          const statusColors = {
            'pendente': 'var(--warning)',
            'em_progresso': 'var(--primary)',
            'concluida': 'var(--secondary)'
          };
          const statusLabels = {
            'pendente': 'Pendente',
            'em_progresso': 'Em Progresso',
            'concluida': 'Concluída'
          };
          return `
            <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
              <h4>${task.title}</h4>
              ${task.description ? `<p style="color: var(--subtext); margin-top: 0.5rem;">${task.description}</p>` : ''}
              <div style="margin-top: 0.5rem;">
                <span style="background: ${statusColors[task.status]}; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem;">${statusLabels[task.status]}</span>
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('selected-day-tasks').style.display = 'block';
      } else {
        document.getElementById('selected-day-tasks').style.display = 'none';
      }

      renderCalendar();
    }

    // Inicializar
    loadNavbar();
    loadTasks();
  </script>
</body>
</html>

